name: Release & Publish

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'README.md'
      - 'PRD.md'
      - 'SPECS.md'
      - 'CHANGELOG.md'

permissions:
  contents: write
  packages: write

jobs:
  release:
    name: Semantic Release
    runs-on: ubuntu-latest
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
  
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
  
      - name: Prepare semantic release
        id: semantic
        uses: cycjimmy/semantic-release-action@v6
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
        with:
          extra_plugins: |
            @semantic-release/changelog
          branches: |
            [
              '+([0-9])?(.{+([0-9]),x}).x',
              'main',
              'next',
              'next-major',
              {name: 'beta', prerelease: true},
              {name: 'alpha', prerelease: true}
            ]
          verify_conditions: true
          analyze_commits: true
          generate_notes: true
          prepare: true
          publish: false
          success: false
          fail: false
  
      - name: Push generated files to main
        uses: CasperWA/push-protected@v2
        with:
          github_token: ${{ steps.app-token.outputs.token }}
          branch: main
          commit_message: |
            chore(release): ${{ steps.semantic.outputs.next_release_version }}


  publish-docker:
    name: Publish Docker Image
    needs: release
    if: needs.release.outputs.new_release_published == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ needs.release.outputs.new_release_version }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
